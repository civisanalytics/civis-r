<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Machine Learning in R with CivisML • civis</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">civis</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/civis_ml.html">Machine Learning in R with CivisML</a>
    </li>
    <li>
      <a href="../articles/concurrency.html">Making Simultaneous Calls to Platform</a>
    </li>
    <li>
      <a href="../articles/data_import_and_export.html">Data Import and Export</a>
    </li>
    <li>
      <a href="../articles/quick_start.html">Getting Started</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/civisanalytics/civis-r">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Machine Learning in R with CivisML</h1>
                        <h4 class="author">Patrick Miller and Liz Sander</h4>
            
            <h4 class="date">2018-1-18</h4>
          </div>

    
    
<div class="contents">
<p>There are so many models to build! When this becomes challenging on a local machine, offloading model building to the cloud can save a lot of time and effort.</p>
<p><a href="https://www.civisanalytics.com/blog/civisml-scikit-learn-at-scale/">CivisML</a> is a machine learning service on Civis Platform that makes this as painless as possible. You can fit many different models, do extensive hyperparameter tuning, and score data sets with millions of observations stored in remote databases. Once these models are built, they live in Civis Platform permanently and can be included into production pipelines. Results can be easily incorporated into reports and dashboards.</p>
<p>CivisML is built in Python using <a href="http://scikit-learn.org/stable/">scikit-learn</a>, and leverages AWS behind the scenes for efficient distributed computing. However, most of its features can be used through R without knowledge of Python or AWS with the <code>civis_ml</code> function in <code>civis</code>.</p>
<p>While <code>civis_ml</code> is a complex function with many arguments, basic machine learning modeling and scoring can be easily carried out. We illustrate several features of <code>civis_ml</code> with data from a fictitious company called Brandable, who is looking to predict which customers are likely to upgrade from the free to the premium service.</p>
<div id="data-sources" class="section level2">
<h2 class="hasAnchor">
<a href="#data-sources" class="anchor"></a>Data sources</h2>
<p>The first step of modeling with <code>civis_ml</code> is to specify the data source, which is the first argument. <code>civis_ml</code> works with local data frames, a CSV on local disk, <a href="https://github.com/wesm/feather">feather-format</a> files, tables in Redshift, and files on S3 (the files endpoint):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(civis)

<span class="kw">civis_ml</span>(df, ...)
<span class="kw">civis_ml</span>(<span class="st">"path/to/data.csv"</span>, ...)
<span class="kw">civis_ml</span>(<span class="kw"><a href="../reference/civis_table.html">civis_table</a></span>(<span class="dt">table_name =</span> <span class="st">"schema.table"</span>, <span class="dt">database_name =</span> <span class="st">"database"</span>), ...)
<span class="kw">civis_ml</span>(<span class="kw"><a href="../reference/civis_file.html">civis_file</a></span>(<span class="dv">1234</span>), ...)</code></pre></div>
<p>The Brandable data is located in a Redshift table called <code>sample_project.premium_training_set</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">civis.default_db =</span> <span class="st">"my_database"</span>)
tab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/civis_table.html">civis_table</a></span>(<span class="dt">table_name =</span> <span class="st">"sample_project.premium_training_set"</span>)</code></pre></div>
<p>Note that <code>civis_table</code> only returns information on where to find the data for <code>civis_ml</code>, not the data itself. <code>civis_table</code> also takes two SQL statements that can be useful for limiting the rows used for training: <code>sql_where</code>, and <code>sql_limit</code>.</p>
</div>
<div id="modeling" class="section level2">
<h2 class="hasAnchor">
<a href="#modeling" class="anchor"></a>Modeling</h2>
<p>After the data source is specified, we next choose the model type. There are 13 named CivisML models that can be called from <code>civis_ml</code>, 6 for classification and 7 for regression. The name of the model corresponds to the name of the estimator in scikit-learn. It can be given in the <code>model_type</code> argument of <code>civis_ml</code>, or called directly using a <code>civis_ml_*</code> function such as <code>civis_ml_sparse_logistic</code>.</p>
<table style="width:89%;" class="table">
<colgroup>
<col width="9%">
<col width="18%">
<col width="18%">
<col width="16%">
<col width="26%">
</colgroup>
<thead><tr class="header">
<th>Name</th>
<th align="left">R Workflow</th>
<th>Model Type</th>
<th>scikit-learn Documentation</th>
<th></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>sparse_logistic</code></td>
<td align="left"><code>civis_ml_sparse_logistic</code></td>
<td>classification</td>
<td><a href="http://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html">Logistic Regression</a></td>
<td></td>
</tr>
<tr class="even">
<td><code>gradient_boosting_classifier</code></td>
<td align="left"><code>civis_ml_gradient_boosting_classifier</code></td>
<td>classification</td>
<td><a href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.GradientBoostingClassifier.html">GradientBoostingClassifier</a></td>
<td></td>
</tr>
<tr class="odd">
<td><code>random_forest_classifier</code></td>
<td align="left"><code>civis_ml_random_forest_classifier</code></td>
<td>classification</td>
<td><a href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">RandomForestClassifier</a></td>
<td></td>
</tr>
<tr class="even">
<td><code>extra_trees_classifier</code></td>
<td align="left"><code>civis_ml_extra_trees_classifier</code></td>
<td>classification</td>
<td><a href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.ExtraTreesClassifier.html">ExtraTreesClassifier</a></td>
<td></td>
</tr>
<tr class="odd">
<td><code>multilayer_perceptron_classifier</code></td>
<td align="left"></td>
<td>classification</td>
<td><a href="https://github.com/civisanalytics/muffnn">MLPClassifier</a></td>
<td></td>
</tr>
<tr class="even">
<td><code>stacking_classifier</code></td>
<td align="left"></td>
<td>classification</td>
<td><a href="https://github.com/civisanalytics/civisml-extensions">StackedClassifier</a></td>
</tr>
<tr class="odd">
<td><code>sparse_linear_regressor</code></td>
<td align="left"><code>civis_ml_sparse_linear_regressor</code></td>
<td>regression</td>
<td><a href="http://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html">LinearRegression</a></td>
<td></td>
</tr>
<tr class="even">
<td><code>sparse_ridge_regressor</code></td>
<td align="left"><code>civis_ml_sparse_ridge_regressor</code></td>
<td>regression</td>
<td><a href="http://scikit-learn.org/stable/modules/generated/sklearn.linear_model.Ridge.html">Ridge</a></td>
<td></td>
</tr>
<tr class="odd">
<td><code>gradient_boosting_regressor</code></td>
<td align="left"><code>civis_ml_gradient_boosting_regressor</code></td>
<td>regression</td>
<td><a href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.GradientBoostingRegressor.html">GradientBoostingRegressor</a></td>
<td></td>
</tr>
<tr class="even">
<td><code>random_forest_regressor</code></td>
<td align="left"><code>civis_ml_random_forest_regressor</code></td>
<td>regression</td>
<td><a href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html">RandomForestRegressor</a></td>
<td></td>
</tr>
<tr class="odd">
<td><code>extra_trees_regressor</code></td>
<td align="left"><code>civis_ml_extra_trees_regressor</code></td>
<td>regression</td>
<td><a href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.ExtraTreesRegressor.html">ExtraTreesRegressor</a></td>
<td></td>
</tr>
<tr class="even">
<td><code>multilayer_perceptron_regressor</code></td>
<td align="left"></td>
<td>regression</td>
<td><a href="https://github.com/civisanalytics/muffnn">MLPRegressor</a></td>
<td></td>
</tr>
<tr class="odd">
<td><code>stacking_regressor</code></td>
<td align="left"></td>
<td>regression</td>
<td><a href="https://github.com/civisanalytics/civisml-extensions">StackedRegressor</a></td>
</tr>
</tbody>
</table>
<p>Documentation on the meta parameters specific to each estimator are provided in <code>?civis_ml_*</code>. For example, the regularization strength parameter <code>C</code> of <code>sparse_logistic</code> is documented in <code><a href="../reference/civis_ml_sparse_logistic.html">?civis_ml_sparse_logistic</a></code>.</p>
<p>For the Brandable data, we use a <code>random_forest</code> classifier to predict the probability that a customer upgrades from free to premium services. For efficiency, we can also denote a <code>primary_key</code>, and a set of <code>excluded_columns</code> that are not included in the model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(civis)
tab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/civis_table.html">civis_table</a></span>(<span class="st">"sample_project.premium_training_set"</span>)
m   &lt;-<span class="st"> </span><span class="kw">civis_ml</span>(tab, <span class="dt">dependent_variable =</span> <span class="st">"upgrade"</span>, 
                <span class="dt">model_type =</span> <span class="st">"random_forest_classifier"</span>, 
                <span class="dt">primary_key =</span> <span class="st">"brandable_user_id"</span>, 
                <span class="dt">excluded_columns =</span> <span class="st">"residential_zip"</span>)

m &lt;-<span class="st"> </span><span class="kw"><a href="../reference/civis_ml_random_forest_classifier.html">civis_ml_random_forest_classifier</a></span>(tab,
      <span class="dt">primary_key =</span> <span class="st">"brandable_user_id"</span>, 
      <span class="dt">excluded_columns =</span> <span class="st">"residential_zip"</span>)</code></pre></div>
<p>Note that if the dependent variables have null values, those rows will be removed before modeling.</p>
<div id="hyperparameter-tuning" class="section level3">
<h3 class="hasAnchor">
<a href="#hyperparameter-tuning" class="anchor"></a>Hyperparameter Tuning</h3>
<p>You can tune hyperparameters using one of two methods: grid search or hyperband. CivisML will perform grid search if you pass a named list of hyperparameters and candidate values to <code>cross_validation_parameters</code>. By default, hyperparameter tuning will run in parallel, using as many jobs as possible without overloading your computing cluster. If you wish to have more control over the number of jobs running at once, you can set it using the <code>n_jobs</code> parameter.</p>
<p><a href="https://arxiv.org/abs/1603.06560">Hyperband</a> is an efficient approach to hyperparameter optimization, and recommended over grid search where possible. CivisML will perform hyperband optimization if you pass the string <code>"hyperband"</code> to <code>cross_validation_parameters</code>. Hyperband cannot be used to tune GLMs. For this reason, preset GLMs do not have a hyperband option. Hyperband is supported for random forests, gradient boosted trees, extra trees, multilayer perceptrons, and the random forest and gradient boosted tree steps of stacking. It is highly recommended that multilayer perceptron models only be used with hyperband.</p>
<p>For the <code>random_forest_classifier</code> in the Brandable data, we try both <code>"hyperband"</code> and grid search for hyperparameter optimization.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/civis_table.html">civis_table</a></span>(<span class="st">"sample_project.premium_training_set"</span>)

<span class="co"># hyperband</span>
m_hyper &lt;-<span class="st"> </span><span class="kw">civis_ml</span>(tab, <span class="dt">dependent_variable =</span> <span class="st">"upgrade"</span>, 
              <span class="dt">model_type =</span> <span class="st">"random_forest_classifier"</span>, 
              <span class="dt">primary_key =</span> <span class="st">"brandable_user_id"</span>, 
              <span class="dt">excluded_columns =</span> <span class="st">"residential_zip"</span>, 
              <span class="dt">cross_validation_parameters =</span> <span class="st">'hyperband'</span>)

<span class="co"># grid search</span>
cv_params &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">"max_depth"</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>), 
                  <span class="st">"n_estimators"</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">500</span>))
  
m_grid &lt;-<span class="st"> </span><span class="kw">civis_ml</span>(tab, <span class="dt">dependent_variable =</span> <span class="st">"upgrade"</span>, 
              <span class="dt">model_type =</span> <span class="st">"random_forest_classifier"</span>, 
              <span class="dt">primary_key =</span> <span class="st">"brandable_user_id"</span>, 
              <span class="dt">excluded_columns =</span> <span class="st">"residential_zip"</span>, 
              <span class="dt">cross_validation_parameters =</span> cv_params)</code></pre></div>
<p>CivisML runs pre-defined models with hyperband using the following distributions:</p>
<table class="table">
<colgroup>
<col width="26%">
<col width="14%">
<col width="58%">
</colgroup>
<thead><tr class="header">
<th>Models</th>
<th>Cost Parameter</th>
<th>Hyperband Distributions</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>gradient_boosting_classifier <br> gradient_boosting_regressor <br> GBT step in stacking_classifier <br> GBT step in stacking_regressor</td>
<td>
<code>n_estimators</code> <br><code>min = 100,</code> <br><code>max = 1000</code>
</td>
<td>
<code>max_depth: randint(low=1, high=5)</code> <br><code>max_features: [None, 'sqrt', 'log2', 0.5, 0.3, 0.1, 0.05, 0.01]</code> <br><code>learning_rate: truncexpon(b=5, loc=.0003, scale=1./167.)</code>
</td>
</tr>
<tr class="even">
<td>———————————-</td>
<td>——————</td>
<td>—————————————————————————</td>
</tr>
<tr class="odd">
<td>random_forest_classifier <br> random_forest_regressor <br> extra_trees_classifier <br> extra_trees_regressor <br> RF step in stacking_classifier <br> RF step in stacking_regressor</td>
<td>
<code>n_estimators</code> <br><code>min = 100,</code> <br><code>max = 1000</code>
</td>
<td>
<code>criterion: ['gini', 'entropy']</code> <br><code>max_features: truncexpon(b=10., loc=.01, scale=1./10.11)</code> <br><code>max_depth: [1, 2, 3, 4, 6, 10, None]</code>
</td>
</tr>
<tr class="even">
<td>———————————-</td>
<td>——————</td>
<td>—————————————————————————</td>
</tr>
<tr class="odd">
<td>multilayer_perceptron_classifier <br> multilayer_perceptron_regressor</td>
<td>
<code>n_epochs</code> <br><code>min = 5,</code> <br><code>max = 50</code>
</td>
<td>
<code>keep_prob: uniform()</code> <br> `<code>hidden_units: [(), (16,), (32,), (64,), (64, 64), (64, 64, 64),</code> <br><code>(128,), (128, 128), (128, 128, 128), (256,),</code> <br><code>(256, 256), (256, 256, 256), (512, 256, 128, 64),</code> <br><code>(1024, 512, 256, 128)]</code> <br><code>learning_rate: [1e-2, 2e-2, 5e-2, 8e-2, 1e-3, 2e-3, 5e-3, 8e-3, 1e-4]</code>
</td>
</tr>
</tbody>
</table>
<p>The truncated exponential distribution for the gradient boosting classifier and regressor was chosen to skew the distribution toward small values, ranging between .0003 and .03, with a mean close to .006. Similarly, the truncated exponential distribution for the random forest and extra trees models skews toward small values, ranging between .01 and 1, and with a mean close to .1.</p>
</div>
<div id="stacking" class="section level3">
<h3 class="hasAnchor">
<a href="#stacking" class="anchor"></a>Stacking</h3>
<p>The <code>"stacking_classifier"</code> model stacks together the <code>"sparse_logistic"</code>, <code>"gradient_boosting_classifier"</code>, and <code>"random_forest_classifier"</code> models using defaults documented in <code>?civis_ml</code>. Each column is first <a href="http://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html">standardized</a>, and then the model predictions are combined using <a href="http://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegressionCV.html">LogisticRegressionCV</a> with <code>penalty='l2'</code> and <code>tol=1e-08</code>. The <code>"stacking_regressor"</code> works similarly, stacking together the <code>"sparse_linear_regressor"</code>, <code>"gradient_boosting_regressor"</code>, and <code>"random_forest_regressor"</code> models, and combining them using <a href="https://github.com/civisanalytics/civisml-extensions">NonNegativeLinearRegression</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m_stack &lt;-<span class="st"> </span><span class="kw">civis_ml</span>(tab, <span class="dt">dependent_variable =</span> <span class="st">"upgrade"</span>, 
              <span class="dt">model_type =</span> <span class="st">"stacking_classifier"</span>, 
              <span class="dt">primary_key =</span> <span class="st">"brandable_user_id"</span>, 
              <span class="dt">excluded_columns =</span> <span class="st">"residential_zip"</span>)</code></pre></div>
</div>
</div>
<div id="results" class="section level2">
<h2 class="hasAnchor">
<a href="#results" class="anchor"></a>Results</h2>
<p>A simple summary of the results from the best fitting model is provided with <code>print</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m</code></pre></div>
<pre><code>## &lt;CivisML random_forest_classifier&gt;
## https://platform.civisanalytics.com/#/models/7072485
## Job id:  7072485  Run id:  58251183 
## 
## AUC:  0.8009
## upgrade:
##                  0      1
## Prop Correct 0.923 0.3297</code></pre>
<p>Following the link takes you to a summary of the model results in Civis Platform. Additional metrics can be computed with <code>get_metric</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/get_metric.html">get_metric</a></span>(m, <span class="st">"accuracy"</span>)</code></pre></div>
<pre><code>## [1] 0.761</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/get_metric.html">get_metric</a></span>(m, <span class="st">"confusion_matrix"</span>)</code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]  671   56
## [2,]  183   90</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/get_metric.html">get_metric</a></span>(m, <span class="st">"roc_auc"</span>)</code></pre></div>
<pre><code>## [1] 0.8009004</code></pre>
<p>Out of sample (or out of fold) scores used in training can be retrieved using <code>fetch_oos_scores</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">oos &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fetch_oos_scores.html">fetch_oos_scores</a></span>(m)
<span class="kw">head</span>(oos)</code></pre></div>
<pre><code>##   brandable_user_id upgrade_1
## 1   00214b9181f2347    0.3280
## 2   0b6cbd77cb8d98b    0.7140
## 3   12ca082b063a3bf    0.4480
## 4   130060adea791e8    0.2060
## 5   1495366621d3834    0.3152
## 6   1a8ed19916ae7c2    0.1600</code></pre>
</div>
<div id="diagnostics" class="section level2">
<h2 class="hasAnchor">
<a href="#diagnostics" class="anchor"></a>Diagnostics</h2>
<p>For classification problems, <code>plot</code> produces a a decile plot using <code>ggplot2</code>. For the premium upgrade model, the decile plot shows that the top-scoring 10% of individuals contain 2.20 times as many targets (people who upgraded) as a randomly selected list of the same size.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(m)</code></pre></div>
<p><img src="civis_ml_files/figure-html/unnamed-chunk-11-1.png" width="480"></p>
<p>For regression problems, <code>plot</code> produces a binned scatter-plot of <span class="math inline">\(y\)</span> against <span class="math inline">\(\hat{y}\)</span>.</p>
<p><code>hist</code> shows the histogram of out of sample (out of fold scores), also using <code>ggplot2</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(m)</code></pre></div>
<p><img src="civis_ml_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
</div>
<div id="prediction-and-scoring" class="section level2">
<h2 class="hasAnchor">
<a href="#prediction-and-scoring" class="anchor"></a>Prediction and Scoring</h2>
<p>CivisML can also be used to score models on hundreds of millions of rows, and distributed over many compute instances. Like many estimators in R, this is done through a <code>predict</code> method. The <code>newdata</code> argument of <code>predict</code> can take any data source supported in <code>civis_ml</code>. Here we use a table in Redshift containing all Brandable users, and output the result to another table in Redshift:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred_tab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/civis_table.html">civis_table</a></span>(<span class="dt">table_name =</span> <span class="st">"sample_project.brandable_all_users"</span>)
pred_job &lt;-<span class="st"> </span><span class="kw">predict</span>(m, <span class="dt">newdata =</span> pred_tab, 
                    <span class="dt">output_table =</span> <span class="st">"sample_project.brandable_user_scores"</span>)</code></pre></div>
<p>Like training and validation, scoring is distributed by default, using up to 90 percent of your computing cluster resources. If you would like to have more control over the number of jobs that are run at once, you can set a maximum using <code>n_jobs</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred_job &lt;-<span class="st"> </span><span class="kw">predict</span>(m, <span class="dt">newdata =</span> pred_tab, 
                    <span class="dt">output_table =</span> <span class="st">"sample_project.brandable_user_scores"</span>, 
                    <span class="dt">n_jobs =</span> <span class="dv">25</span>)</code></pre></div>
<p>The predictions can be loaded into memory using <code>fetch_predictions</code>, which downloads directly from S3:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">yhat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fetch_predictions.html">fetch_predictions</a></span>(pred_job)</code></pre></div>
<p>Note that if the table of predictions exceeds available memory, it may be helpful to use <code>download_civis</code> instead.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># download from S3</span>
<span class="kw"><a href="../reference/download_civis.html">download_civis</a></span>(pred_job<span class="op">$</span>model_info<span class="op">$</span>output_file_ids, <span class="dt">path =</span> <span class="st">"my_predictions.csv"</span>)

<span class="co"># download from Redshift </span>
<span class="kw"><a href="../reference/download_civis.html">download_civis</a></span>(<span class="st">"sample_project.brandable_user_scores"</span>)</code></pre></div>
</div>
<div id="retrieving-existing-models" class="section level2">
<h2 class="hasAnchor">
<a href="#retrieving-existing-models" class="anchor"></a>Retrieving Existing models</h2>
<p>An existing model (or particular run of an existing model) can be retrieved using <code>civis_ml_fetch_existing</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model_id &lt;-<span class="st"> </span>m<span class="op">$</span>job<span class="op">$</span>id
m &lt;-<span class="st"> </span><span class="kw"><a href="../reference/civis_ml.html">civis_ml_fetch_existing</a></span>(model_id)</code></pre></div>
</div>
<div id="error-handling" class="section level2">
<h2 class="hasAnchor">
<a href="#error-handling" class="anchor"></a>Error Handling</h2>
<p>Unfortunately, many kinds of errors can occur. When an error occurs within CivisML, a <code>civis_ml_error</code> is thrown. By default, the log from the CivisML job is printed, which is useful for debugging.</p>
<p>Here is an example error from misspelling the model type:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">civis_ml</span>(tab, <span class="dt">dependent_variable =</span> <span class="st">"upgrade"</span>, 
         <span class="dt">model_type =</span> <span class="st">"random_fest_classifier"</span>, 
         <span class="dt">primary_key =</span> <span class="st">"brandable_user_id"</span>, 
         <span class="dt">excluded_columns =</span> <span class="st">"residential_zip"</span>, 
         <span class="dt">cross_validation_parameters =</span> cv_params)</code></pre></div>
<pre><code>## &lt;civis_ml_error&gt;
## scripts_get_custom_runs(id = 7077157, run_id = 58263925): 
## 2017-08-29 13:01:54 PM CDT Queued
## 2017-08-29 13:01:55 PM CDT Running
## 2017-08-29 13:01:57 PM CDT Dedicating resources
## 2017-08-29 13:01:58 PM CDT Downloading code and container
## 2017-08-29 13:01:59 PM CDT Executing script
## 2017-08-29 13:02:03 PM CDT Please select one of the pre-defined models: ['sparse_logistic', 'sparse_linear_regressor', 'sparse_ridge_regressor', 'gradient_boosting_classifier', 'random_forest_classifier', 'extra_trees_classifier', 'gradient_boosting_regressor', 'random_forest_regressor', 'extra_trees_regressor']
## 2017-08-29 13:02:05 PM CDT Process used approximately 97.57 MiB of its 3188 MiB memory limit
## 2017-08-29 13:02:05 PM CDT Failed
## 2017-08-29 13:02:06 PM CDT Error on job: Process ended with an error, exiting: 1.</code></pre>
<p>If you don’t understand the error message, providing the error message, job, and run ids to support is the best way to get help!</p>
</div>
<div id="programming-with-civis_ml" class="section level2">
<h2 class="hasAnchor">
<a href="#programming-with-civis_ml" class="anchor"></a>Programming with <code>civis_ml</code>
</h2>
<p>When programming with <code>civis_ml</code>, errors can be caught using the base R <code>try</code> or <code>tryCatch</code>. In <code>civis</code>, we provide functions for getting debugging information using <code>get_error</code> or just the logs using <code>fetch_logs</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">e &lt;-<span class="st"> </span><span class="kw">tryCatch</span>({
  <span class="kw">civis_ml</span>(tab, <span class="dt">dependent_variable =</span> <span class="st">"upgrade"</span>, 
        <span class="dt">model_type =</span> <span class="st">"random_fest_classifier"</span>, 
        <span class="dt">primary_key =</span> <span class="st">"brandable_user_id"</span>, 
        <span class="dt">excluded_columns =</span> <span class="st">"residential_zip"</span>)
  }, <span class="dt">civis_ml_error =</span> <span class="cf">function</span>(e) e)
<span class="kw"><a href="../reference/get_error.html">get_error</a></span>(e)
<span class="kw"><a href="../reference/fetch_logs.html">fetch_logs</a></span>(e)</code></pre></div>
<p>Error handling can be used to implement more robust workflow programming with <code>civis_ml</code>. In the following function, we implement <code>retry_model</code>, which retries on e.g. connection failures but not on a <code>civis_ml_error</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">retry_model &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">max_retries =</span> <span class="dv">5</span>) {
  i &lt;-<span class="st"> </span><span class="dv">1</span>
  <span class="cf">while</span> (i <span class="op">&lt;</span><span class="st"> </span>max_retries) {
    <span class="kw">tryCatch</span>({
      m &lt;-<span class="st"> </span><span class="kw">civis_ml</span>(tab, <span class="dt">dependent_variable =</span> <span class="st">"upgrade"</span>, 
               <span class="dt">model_type =</span> <span class="st">"random_forest_classifier"</span>, 
               <span class="dt">primary_key =</span> <span class="st">"brandable_user_id"</span>, 
               <span class="dt">excluded_columns =</span> <span class="st">"residential_zip"</span>)
      <span class="kw">return</span>(m)
    }, <span class="dt">civis_ml_error =</span> <span class="cf">function</span>(e) <span class="kw">stop</span>(e))
    <span class="kw">cat</span>(<span class="st">"Retry: "</span>, i, <span class="dt">fill =</span> <span class="ot">TRUE</span>)
    i &lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
  }
  <span class="kw">stop</span>(<span class="st">"Exceeded maximum retries."</span>)
}</code></pre></div>
<p>Workflow programming could be further enhanced by printing the logs, storing the error object, or writing error logs to a file or database.</p>
</div>
<div id="appendix" class="section level2">
<h2 class="hasAnchor">
<a href="#appendix" class="anchor"></a>Appendix</h2>
<div id="parallelization" class="section level3">
<h3 class="hasAnchor">
<a href="#parallelization" class="anchor"></a>Parallelization</h3>
<p>To fit many models in parallel using <code>parallel</code>, <code>foreach</code>, or <code>future</code>, check out <a href="https://civisanalytics.github.io/civis-r/articles/concurrency.html">this article</a> or the vignette on concurrency at <code>browseVignettes("civis")</code>.</p>
</div>
<div id="sample-weights" class="section level3">
<h3 class="hasAnchor">
<a href="#sample-weights" class="anchor"></a>Sample weights</h3>
<p>Many estimators take a <code>sample_weight</code> argument. This can be be specified with the <code>fit_params</code> argument of <code>civis_ml</code> using <code>list(sample_weight = 'survey_weight_column')</code>.</p>
</div>
<div id="missing-data" class="section level3">
<h3 class="hasAnchor">
<a href="#missing-data" class="anchor"></a>Missing data</h3>
<p>Modeling data must be complete. Any missing values will be imputed with the mean of non-null values in a column.</p>
</div>
<div id="more-information" class="section level3">
<h3 class="hasAnchor">
<a href="#more-information" class="anchor"></a>More information</h3>
<p>Custom estimators can be written in Python and included in CivisML if they follow the scikit-learn API. For example, the <code>sparse_logistic</code>, <code>sparse_linear_regressor</code>, and <code>sparse_ridge_regressor</code> models all use the public Civis Analytics <a href="https://github.com/civisanalytics/python-glmnet">glmnet</a> wrapper in Python.</p>
<p>Browse <a href="https://civis-python.readthedocs.io/en/stable/ml.html">the CivisML documentation</a> for more details!</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#data-sources">Data sources</a></li>
      <li><a href="#modeling">Modeling</a></li>
      <li><a href="#results">Results</a></li>
      <li><a href="#diagnostics">Diagnostics</a></li>
      <li><a href="#prediction-and-scoring">Prediction and Scoring</a></li>
      <li><a href="#retrieving-existing-models">Retrieving Existing models</a></li>
      <li><a href="#error-handling">Error Handling</a></li>
      <li><a href="#programming-with-civis_ml">Programming with <code>civis_ml</code></a></li>
      <li><a href="#appendix">Appendix</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Patrick Miller, Keith Ingersoll.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
