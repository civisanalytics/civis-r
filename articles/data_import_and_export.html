<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Import and Export • civis</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">civis</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/concurrency.html">Making Simultaneous Calls to Platform</a>
    </li>
    <li>
      <a href="../articles/data_import_and_export.html">Data Import and Export</a>
    </li>
    <li>
      <a href="../articles/quick_start.html">Getting Started</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/civisanalytics/civis-r">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Data Import and Export</h1>
                        <h4 class="author">Patrick Miller, Keith Ingersoll</h4>
            
            <h4 class="date">2017-08-14</h4>
          </div>

    
    
<div class="contents">
<div id="passing-data-back-and-forth" class="section level2">
<h2 class="hasAnchor">
<a href="#passing-data-back-and-forth" class="anchor"></a>Passing Data Back and Forth</h2>
<p>Often the simplest, but most useful operation when working with the Platform is to move data in and out. From the perspective of the R client, we call moving data from the Platform to the local machine <em>reading</em>. Likewise, moving data from the local machine to the Platform is called <em>writing</em>.</p>
<p>The <code>civis</code> client handles data imports and exports in two basic ways:</p>
<ol style="list-style-type: decimal">
<li>Moving data directly between the R workspace and the Platform (the most common use case).</li>
<li>Moving data between the Platform and local csv files (this is useful for large data that doesn’t fit into memory).</li>
</ol>
<p>Data can be stored on Platform in two places:</p>
<ol style="list-style-type: decimal">
<li>Amazon Redshift, a SQL database.</li>
<li>Amazon S3, also referred to as the ‘files’ endpoint.</li>
</ol>
<p>Tables in Redshift are accessed and modified using SQL queries. Tables in Redshift can be easily shared and used in multiple workflows by multiple people. However, importing and exporting even small files on Redshift can be slow.</p>
<p>R objects and arbitrary files can be stored on Amazon S3, and are accessed using a numeric file id. In <code>civis</code>, R objects are serialized using <code>saveRDS</code> for speed and efficiency. Text or csv files created by other programs can also be read back into R as a data frames.</p>
</div>
<div id="reading-data-into-r-from-platform" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-data-into-r-from-platform" class="anchor"></a>Reading Data Into R From Platform</h2>
<p>The main workhose for getting data from Platform is <code>read_civis</code>. This function is designed to work similarly to the built in function <code>read.csv</code>, returning a dataframe from a table in Platform. For more flexibility, <code>read_civis</code> can download files from Redshift using an SQL query, or download a file from S3 (‘the files endpoint’) using a file id.</p>
<p>To read from a table in Platform, simply provide the name of the schema, table within the schema, and the database:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_civis.html">read_civis</a></span>(<span class="st">"schema.tablename"</span>, <span class="dt">database =</span> <span class="st">"my-database"</span>)</code></pre></div>
<p>For convenience, a default database can be set in the package options, and not specified in further calls to any IO function. If there is only one database available, this database will automatically be used as the default. In the examples that follow, we assume that a default database has been set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">civis.default_db =</span> <span class="st">"my-database"</span>)
df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_civis.html">read_civis</a></span>(<span class="st">"schema.tablename"</span>)</code></pre></div>
<p><code>read_civis</code> accepts SQL queries when more flexibility is needed. This is accomplished by wrapping <code><a href="http://dplyr.tidyverse.org/reference/sql.html">sql(...)</a></code> around a string containing the query. With <code>read_civis</code>, queries are always read only, and always return a <code>data.frame</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">query &lt;-<span class="st"> "SELECT * FROM table JOIN other_table USING id WHERE var1 &lt; 23"</span>
df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_civis.html">read_civis</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/sql.html">sql</a></span>(query))</code></pre></div>
<p>Finally, <code>read_civis</code> accepts a file id as the first argument to read in files from S3 as data frames. IDs are obtained from <code>write_civis_file</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(iris)
id &lt;-<span class="st"> </span><span class="kw"><a href="../reference/write_civis_file.html">write_civis_file</a></span>(iris)
df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_civis.html">read_civis</a></span>(id)</code></pre></div>
<p>For maximum flexibility, <code>read_civis</code> accepts parameters from <code>read.csv</code> which can be used to define data types when the defaults are not appropriate. For instance, when numbers should be read in as characters or when strings shouldn’t be read in as factors.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">query &lt;-<span class="st"> "SELECT * FROM table JOIN other_table USING id WHERE var1 &lt; 23"</span>
df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_civis.html">read_civis</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/sql.html">sql</a></span>(query), <span class="dt">colClasses =</span> <span class="st">"character"</span>)
df2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_civis.html">read_civis</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/sql.html">sql</a></span>(query), <span class="dt">as.is =</span> <span class="ot">TRUE</span>)</code></pre></div>
</div>
<div id="uploading-data-to-platform" class="section level2">
<h2 class="hasAnchor">
<a href="#uploading-data-to-platform" class="anchor"></a>Uploading Data to Platform</h2>
<p>The complement to reading data into the R workspace is writing data to the Platform. The function <code>write_civis</code> uploads data frames or csv files to an Amazon Redshift database. The function <code>write_civis_file</code> uploads R objects and arbitrary files to Amazon S3 (the files endpoint).</p>
<p>When creating a new table, <code>write_civis</code> relies on Platform to determine data types. Distkeys and sortkeys can optionally be set to improve query performance. Again, we set a default database in these examples for convenience.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">civis.default_db =</span> <span class="st">"my_database"</span>)
df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">rnorm</span>(<span class="dv">100</span>), <span class="dt">y =</span> <span class="kw">rnorm</span>(<span class="dv">100</span>), <span class="dt">z =</span> <span class="kw">rnorm</span>(<span class="dv">100</span>))
<span class="kw"><a href="../reference/write_civis.html">write_civis</a></span>(df, <span class="dt">tablename =</span> <span class="st">"schema.tablename"</span>,
            <span class="dt">distkey =</span> <span class="st">"id"</span>, <span class="dt">sortkey1 =</span> <span class="st">"date"</span>, <span class="dt">sortkey2 =</span> <span class="st">"type"</span>)</code></pre></div>
<p>By default, <code>write_civis</code> will fail if the table passed in <code>tablename</code> already exists. Optionally, <code>write_civis</code> can append to an existing table. It may also delete all rows and then append (truncate). If specific datatypes are required, a table may first be created with a SQL <code>CREATE TABLE</code> command and then data can be inserted with <code>write_civis</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/write_civis.html">write_civis</a></span>(df, <span class="dt">tablename =</span> <span class="st">"schema.tablename"</span>, <span class="dt">if_exists =</span> <span class="st">"append"</span>)
<span class="kw"><a href="../reference/write_civis.html">write_civis</a></span>(df, <span class="dt">tablename =</span> <span class="st">"schema.tablename"</span>, <span class="dt">if_exists =</span> <span class="st">"truncate"</span>)</code></pre></div>
<p>If a csv file is saved to disk but not loaded in the R workspace, <code>write_civis</code> will upload the csv to Platform without needing first load the csv into RAM. This can save time when a file is large. Uploading a csv directly to Platform is done by simply passing the file name and path to <code>write_civis</code> as the first argument:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/write_civis.html">write_civis</a></span>(<span class="st">"~/path/to/my_data.csv"</span>, <span class="dt">tablename=</span><span class="st">"schema.tablename"</span>)</code></pre></div>
<p>Finally, <code>write_civis_file</code> uploads R objects and files to Amazon S3, which is also referred to as the ‘files endpoint.’ R objects saved to the files endpoint expire after 30 days and are serialized using <code>saveRDS</code>. R objects can be loaded back into memory by passing the file id to <code>read_civis</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(iris)
id &lt;-<span class="st"> </span><span class="kw"><a href="../reference/write_civis_file.html">write_civis_file</a></span>(iris)
iris2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_civis.html">read_civis</a></span>(id)</code></pre></div>
<p>When passed a file name and path, <code>write_civis_file</code> will upload the file to S3 as-is. To read the file back into memory as a data frame, an appropriate function to convert the file to a data frame must be provided to the <code>using</code> argument of <code>read_civis</code>. For example, a csv on the files endpoint can be read back into R as a data frame by setting <code>using = read.csv</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">id &lt;-<span class="st"> </span><span class="kw"><a href="../reference/write_civis_file.html">write_civis_file</a></span>(<span class="st">"path/to/my_data.csv"</span>)
<span class="kw"><a href="../reference/read_civis.html">read_civis</a></span>(id, <span class="dt">using =</span> read.csv)</code></pre></div>
</div>
<div id="downloading-large-data-sets-from-platform-" class="section level2">
<h2 class="hasAnchor">
<a href="#downloading-large-data-sets-from-platform-" class="anchor"></a>Downloading Large Data Sets from Platform.</h2>
<p>Occasionally, a table may be too large to store in memory. <code>download_civis</code> can be used in place of <code>read_civis</code> to download data straight to disk from Platform.</p>
<p>Like <code>read_civis</code>, <code>download_civis</code> can download files from Amazon Redshift by passing <code>schema.tablename</code>, or <code><a href="http://dplyr.tidyverse.org/reference/sql.html">sql(...)</a></code> as the first argument. Files can be downloaded from Amazon S3 by passing the file id to <code>download_civis</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">query &lt;-<span class="st"> "SELECT * FROM table JOIN other_table USING id WHERE var1 &lt; 23"</span>
<span class="kw"><a href="../reference/download_civis.html">download_civis</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/sql.html">sql</a></span>(query), <span class="dt">file =</span> <span class="st">"path/to/my_file.csv"</span>)
<span class="kw"><a href="../reference/download_civis.html">download_civis</a></span>(<span class="st">"schema.tablename"</span>, <span class="dt">file =</span> <span class="st">"path/to/my_file.csv"</span>)

id &lt;-<span class="st"> </span><span class="kw"><a href="../reference/write_civis_file.html">write_civis_file</a></span>(iris)
<span class="kw"><a href="../reference/download_civis.html">download_civis</a></span>(id, <span class="dt">file =</span> <span class="st">"path/to/my_iris.rds"</span>)</code></pre></div>
</div>
<div id="running-queries-on-platform" class="section level2">
<h2 class="hasAnchor">
<a href="#running-queries-on-platform" class="anchor"></a>Running Queries on Platform</h2>
<p>Arbitrary queries can be run on Redshift using <code>query_civis</code>, which returns the meta-data of the query.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q_res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/query_civis.html">query_civis</a></span>(<span class="st">"GRANT ALL ON schema.my_table TO GROUP admin"</span>)</code></pre></div>
<p>Existing queries can be re-run by passing the query id to <code>query_civis</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">id &lt;-<span class="st"> </span>q_res$id
<span class="kw"><a href="../reference/query_civis.html">query_civis</a></span>(id)</code></pre></div>
</div>
<div id="common-errors" class="section level2">
<h2 class="hasAnchor">
<a href="#common-errors" class="anchor"></a>Common Errors</h2>
<div id="civis-api-key-not-properly-set-or-has-expired-" class="section level4">
<h4 class="hasAnchor">
<a href="#civis-api-key-not-properly-set-or-has-expired-" class="anchor"></a>Civis API key not properly set or has expired.</h4>
<p>Often an improper API key will return an error like below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> Error in <span class="kw">api_key</span>() :<span class="st"> </span>
<span class="st">  </span>The environmental variable CIVIS_API_KEY is not set. Add this to your .Renviron or call <span class="kw">Sys.setenv</span>(<span class="dt">CIVIS_API_KEY =</span> <span class="st">'&lt;api_key&gt;'</span>) </code></pre></div>
<p>However, there may be cases where the errors are less straightforward. It is a good idea to test that API credentials are properly set with a simple call such as <code><a href="http://www.rdocumentation.org/packages/civis/topics/users_list_me">civis::users_list_me()</a></code>. See the README to set up API keys correctly.</p>
</div>
<div id="query-does-not-return-any-results-" class="section level4">
<h4 class="hasAnchor">
<a href="#query-does-not-return-any-results-" class="anchor"></a>Query does not return any results.</h4>
<p>This may happen if a table is empty or when no rows match a <code>WHERE</code> statement. To fix, double check that the query is correct or the table is not empty.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/read_civis.html">read_civis</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/sql.html">sql</a></span>(<span class="st">"SELECT * FROM schema.tablename WHERE 1 = 0"</span>))
Error in <span class="kw">download_script_results</span>(run$script_id, run$run_id) :<span class="st"> </span>
<span class="st">  </span>Query produced no output. </code></pre></div>
</div>
<div id="database-not-set-correctly-" class="section level4">
<h4 class="hasAnchor">
<a href="#database-not-set-correctly-" class="anchor"></a>Database not set correctly.</h4>
<p>For both <code>read_civis</code> and <code>write_civis</code>, the database must be set to the correct, case sensitive name (not hostname) of the database.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> Error in <span class="kw">get_db</span>(database) :<span class="st"> </span>
<span class="st">  </span>Argument database is <span class="ot">NULL</span> and <span class="kw">options</span>(<span class="st">"civis.default_db"</span>) not set. Set this option using <span class="kw">options</span>(<span class="dt">civis.default_db =</span> <span class="st">"my_database"</span>) </code></pre></div>
<p>To see a complete list of database names, run:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sapply</span>(<span class="kw"><a href="../reference/databases_list.html">databases_list</a></span>(), function(x) x$name)</code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#passing-data-back-and-forth">Passing Data Back and Forth</a></li>
      <li><a href="#reading-data-into-r-from-platform">Reading Data Into R From Platform</a></li>
      <li><a href="#uploading-data-to-platform">Uploading Data to Platform</a></li>
      <li><a href="#downloading-large-data-sets-from-platform-">Downloading Large Data Sets from Platform.</a></li>
      <li><a href="#running-queries-on-platform">Running Queries on Platform</a></li>
      <li><a href="#common-errors">Common Errors</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bill Lattner, Patrick Miller, Keith Ingersoll, Anh Le.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
