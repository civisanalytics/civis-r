<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Making Simultaneous Calls to Platform • civis</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Making Simultaneous Calls to Platform">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">civis</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/civis_ml.html">Machine Learning in R with CivisML</a>
    </li>
    <li>
      <a href="../articles/civis_scripts.html">Productionizing with Civis Scripts</a>
    </li>
    <li>
      <a href="../articles/concurrency.html">Making Simultaneous Calls to Platform</a>
    </li>
    <li>
      <a href="../articles/data_import_and_export.html">Data Import and Export</a>
    </li>
    <li>
      <a href="../articles/quick_start.html">Getting Started</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/civisanalytics/civis-r">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Making Simultaneous Calls to Platform</h1>
            
            <h4 class="date">2017-08-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/civisanalytics/civis-r/blob/master/vignettes/concurrency.Rmd"><code>vignettes/concurrency.Rmd</code></a></small>
      <div class="hidden name"><code>concurrency.Rmd</code></div>

    </div>

    
    
<div id="concurrency-in-the-civis-r-client" class="section level2">
<h2 class="hasAnchor">
<a href="#concurrency-in-the-civis-r-client" class="anchor"></a>Concurrency in the Civis R Client</h2>
<p>Just like most functions in R, all functions in <code>civis</code> block. This means that each function in a program must complete before the next function runs. For instance,</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">nap &lt;-<span class="st"> </span><span class="cf">function</span>(seconds) {</a>
<a class="sourceLine" id="cb1-2" title="2">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.sleep">Sys.sleep</a></span>(seconds)</a>
<a class="sourceLine" id="cb1-3" title="3">}</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5">start &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">nap</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">nap</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">nap</span>(<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb1-9" title="9">end &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(end <span class="op">-</span><span class="st"> </span>start)</a></code></pre></div>
<p>This program takes 6 seconds to complete, since it takes 1 second for the first <code>nap</code>, 2 for the second and 3 for the last. This program is easy to reason about because each function is sequentially executed. Usually, that is how we want our programs to run.</p>
<p>There are some exceptions to this rule. Sequentially executing each function might be inconvenient if each <code>nap</code> took 30 minutes instead of a few seconds. In that case, we might like our program to perform all 3 naps simultaneously. In the above example, running all 3 naps simultaneously would take 3 seconds (the length of the longest nap) rather than 6 seconds.</p>
<p>As all function calls in <code>civis</code> block, <code>civis</code> relies on the mature R ecosystem for parallel programming to enable multiple simultaneous tasks. The three packages we introduce are <code>future</code>, <code>foreach</code>, and <code>parallel</code> (included in base R). For all packages, simultaneous tasks are enabled by starting each task in a separate R process. Examples for building several models in parallel with different libraries are included below. The libraries have strengths and weaknesses and choosing which library to use is often a matter of preference.</p>
<p>It is important to note that when calling <code>civis</code> functions, the computation required to complete the task takes place in Platform. For instance, during a call to <code>civis_ml</code>, Platform builds the model while your laptop waits for the task to complete. This means that you don’t have to worry about running out of memory or cpu cores on your laptop when training dozens of models, or when scoring a model on a very large population. The task being parallelized in the code below is simply the task of waiting for Platform to send results back to your laptop.</p>
</div>
<div id="building-many-models-with-future" class="section level2">
<h2 class="hasAnchor">
<a href="#building-many-models-with-future" class="anchor"></a>Building Many Models with <code>future</code>
</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(future)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(civis)</a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co"># Define a concurrent backend with enough processes so each function</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co"># we want to run concurrently has its own process. Here we'll need at least 2.</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(<span class="st">"multiprocess"</span>, <span class="dt">workers=</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb2-7" title="7"></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co"># Load data</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(iris)</a>
<a class="sourceLine" id="cb2-10" title="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(airquality)</a>
<a class="sourceLine" id="cb2-11" title="11">airquality &lt;-<span class="st"> </span>airquality[<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(airquality<span class="op">$</span>Ozone),]  <span class="co"># remove missing in dv</span></a>
<a class="sourceLine" id="cb2-12" title="12"></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="co"># Create a future for each model, using the special %&lt;-% assignment operator.</span></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="co"># These futures are created immediately, kicking off the models.</span></a>
<a class="sourceLine" id="cb2-15" title="15">air_model <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../reference/civis_ml.html">civis_ml</a></span>(airquality, <span class="st">"Ozone"</span>, <span class="st">"gradient_boosting_regressor"</span>)</a>
<a class="sourceLine" id="cb2-16" title="16">iris_model <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../reference/civis_ml.html">civis_ml</a></span>(iris, <span class="st">"Species"</span>, <span class="st">"sparse_logistic"</span>)</a>
<a class="sourceLine" id="cb2-17" title="17"></a>
<a class="sourceLine" id="cb2-18" title="18"><span class="co"># At this point, `air_model` has not finished training yet. That's okay,</span></a>
<a class="sourceLine" id="cb2-19" title="19"><span class="co"># the program will just wait until `air_model` is done before printing it.</span></a>
<a class="sourceLine" id="cb2-20" title="20"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="st">"airquality R^2:"</span>)</a>
<a class="sourceLine" id="cb2-21" title="21"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(air_model<span class="op">$</span>metrics<span class="op">$</span>metrics<span class="op">$</span>r_squared)</a>
<a class="sourceLine" id="cb2-22" title="22"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="st">"iris ROC:"</span>)</a>
<a class="sourceLine" id="cb2-23" title="23"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(iris_model<span class="op">$</span>metrics<span class="op">$</span>metrics<span class="op">$</span>roc_auc)</a></code></pre></div>
</div>
<div id="building-many-models-with-foreach" class="section level2">
<h2 class="hasAnchor">
<a href="#building-many-models-with-foreach" class="anchor"></a>Building Many Models with <code>foreach</code>
</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(parallel)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(doParallel)</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(foreach)</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(civis)</a>
<a class="sourceLine" id="cb3-5" title="5"></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co"># Register a local cluster with enough processes so each function</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co"># we want to run concurrently has its own process. Here we'll</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co"># need at least 3, with 1 for each model_type in model_types.</span></a>
<a class="sourceLine" id="cb3-9" title="9">cluster &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/parallel/topics/makeCluster">makeCluster</a></span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb3-10" title="10"><span class="kw">registerDoParallel</span>(cluster)</a>
<a class="sourceLine" id="cb3-11" title="11"></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co"># Model types to build</span></a>
<a class="sourceLine" id="cb3-13" title="13">model_types &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"sparse_logistic"</span>,</a>
<a class="sourceLine" id="cb3-14" title="14">                 <span class="st">"gradient_boosting_classifier"</span>,</a>
<a class="sourceLine" id="cb3-15" title="15">                 <span class="st">"random_forest_classifier"</span>)</a>
<a class="sourceLine" id="cb3-16" title="16"></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="co"># Load data</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(iris)</a>
<a class="sourceLine" id="cb3-19" title="19"></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="co"># Listen for multiple models to complete concurrently</span></a>
<a class="sourceLine" id="cb3-21" title="21">model_results &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/foreach/topics/foreach">foreach</a></span>(<span class="dt">model_type=</span><span class="kw">iter</span>(model_types), <span class="dt">.packages=</span><span class="st">'civis'</span>) <span class="op">%dopar%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb3-22" title="22">    <span class="kw"><a href="../reference/civis_ml.html">civis_ml</a></span>(iris, <span class="st">"Species"</span>, model_type)</a>
<a class="sourceLine" id="cb3-23" title="23">}</a>
<a class="sourceLine" id="cb3-24" title="24"><span class="kw"><a href="https://www.rdocumentation.org/packages/parallel/topics/makeCluster">stopCluster</a></span>(cluster)</a>
<a class="sourceLine" id="cb3-25" title="25"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="st">"ROC Results"</span>)</a>
<a class="sourceLine" id="cb3-26" title="26"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(model_results, <span class="cf">function</span>(result) result<span class="op">$</span>metrics<span class="op">$</span>metrics<span class="op">$</span>roc_auc)</a></code></pre></div>
</div>
<div id="building-many-models-with-mcparallel" class="section level2">
<h2 class="hasAnchor">
<a href="#building-many-models-with-mcparallel" class="anchor"></a>Building Many Models with <code>mcparallel</code>
</h2>
<p>Note: <code>mcparallel</code> relies on forking and thus is not available on Windows.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(civis)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(parallel)</a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co"># Model types to build</span></a>
<a class="sourceLine" id="cb4-5" title="5">model_types &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"sparse_logistic"</span>,</a>
<a class="sourceLine" id="cb4-6" title="6">                 <span class="st">"gradient_boosting_classifier"</span>,</a>
<a class="sourceLine" id="cb4-7" title="7">                 <span class="st">"random_forest_classifier"</span>)</a>
<a class="sourceLine" id="cb4-8" title="8"></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co"># Load data</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(iris)</a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="co"># Loop over all models in parallel with a max of 10 processes</span></a>
<a class="sourceLine" id="cb4-13" title="13">model_results &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(model_types, <span class="cf">function</span>(model_type) {</a>
<a class="sourceLine" id="cb4-14" title="14">  <span class="kw"><a href="../reference/civis_ml.html">civis_ml</a></span>(iris, <span class="st">"Species"</span>, model_type)</a>
<a class="sourceLine" id="cb4-15" title="15">}, <span class="dt">mc.cores=</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb4-16" title="16"></a>
<a class="sourceLine" id="cb4-17" title="17"><span class="co"># Wait for all models simultaneously</span></a>
<a class="sourceLine" id="cb4-18" title="18"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="st">"ROC Results"</span>)</a>
<a class="sourceLine" id="cb4-19" title="19"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(model_results, <span class="cf">function</span>(result) result<span class="op">$</span>metrics<span class="op">$</span>metrics<span class="op">$</span>roc_auc)</a></code></pre></div>
</div>
<div id="operating-system-environment-specific-errors" class="section level2">
<h2 class="hasAnchor">
<a href="#operating-system-environment-specific-errors" class="anchor"></a>Operating System / Environment Specific Errors</h2>
<p>Differences in operating systems and R environments may cause errors for some users of the parallel libraries listed above. In particular, <code>mclapply</code> does not work on Windows and may not work in RStudio on certain operating systems. <code>future</code> may require <code><a href="https://www.rdocumentation.org/packages/future/topics/plan">plan(multisession)</a></code> on certain operating systems. If you encounter an error parallelizing functions in <code>civis</code>, we recommend first trying more than one method listed above. While we will address errors specific to <code>civis</code> with regards to parallel code, the technicalities of parallel libraries in R across operating systems and environments prevent us from providing more general support for issues regarding parallelized code in R.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#concurrency-in-the-civis-r-client">Concurrency in the Civis R Client</a></li>
      <li><a href="#building-many-models-with-future">Building Many Models with <code>future</code></a></li>
      <li><a href="#building-many-models-with-foreach">Building Many Models with <code>foreach</code></a></li>
      <li><a href="#building-many-models-with-mcparallel">Building Many Models with <code>mcparallel</code></a></li>
      <li><a href="#operating-system-environment-specific-errors">Operating System / Environment Specific Errors</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Patrick Miller, Keith Ingersoll.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
